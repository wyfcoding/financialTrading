apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: {{ include "aml.fullname" . }}
  labels:
    {{- include "aml.labels" . | nindent 4 }}
spec:
  hosts:
    - {{ include "aml.fullname" . }}
  http:
    - route:
        - destination:
            host: {{ include "aml.fullname" . }}
            port:
              number: {{ .Values.service.grpcPort }}
      retries:
        attempts: 3
        perTryTimeout: 10s
        retryOn: gateway-error,connect-failure,refused-stream
---
apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: {{ include "aml.fullname" . }}
  labels:
    {{- include "aml.labels" . | nindent 4 }}
spec:
  host: {{ include "aml.fullname" . }}
  trafficPolicy:
    connectionPool:
      tcp:
        maxConnections: 100
        connectTimeout: 5s
      http:
        h2UpgradePolicy: UPGRADE
        http1MaxPendingRequests: 100
        http2MaxRequests: 1000
    outlierDetection:
      consecutive5xxErrors: 5
      interval: 30s
      baseEjectionTime: 30s
      maxEjectionPercent: 50
    tls:
      mode: ISTIO_MUTUAL
