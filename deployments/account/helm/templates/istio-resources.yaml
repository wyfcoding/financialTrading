apiVersion: networking.istio.io/v1beta1
kind: Gateway
metadata:
  name: {{ include "account.fullname" . }}-gateway
  namespace: {{ .Release.Namespace }}
spec:
  selector:
    istio: ingressgateway
  servers:
  - port:
      number: 80
      name: http
      protocol: HTTP
    hosts:
    - "api.trading.com"
  - port:
      number: 443
      name: https
      protocol: HTTPS
    tls:
      mode: TERMINATE
      credentialName: ecommerce-credential
    hosts:
    - "api.trading.com"
---
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: {{ include "account.fullname" . }}
  namespace: {{ .Release.Namespace }}
spec:
  hosts:
  - api.trading.com
  - {{ include "account.fullname" . }}.{{ .Release.Namespace }}.svc.cluster.local
  gateways:
  - {{ include "account.fullname" . }}-gateway
  - mesh
  http:
  {{- if .Values.canary.enabled }}
  # 1. 基于 Header 的精准金丝雀路由
  - match:
    - headers:
        {{ .Values.canary.headerMatch.key }}:
          exact: {{ .Values.canary.headerMatch.value | quote }}
      uri:
        prefix: /api/v1/accounts
    route:
    - destination:
        host: {{ include "account.fullname" . }}
        subset: {{ .Values.canary.version }}
        port:
          number: {{ .Values.service.httpPort }}

  # 2. 流量百分比分发与镜像 (Shadow Traffic)
  - match:
    - uri:
        prefix: /api/v1/accounts
    mirror:
      host: {{ include "account.fullname" . }}
      subset: {{ .Values.canary.version }}
    mirrorPercentage:
      value: 10.0
    route:
    - destination:
        host: {{ include "account.fullname" . }}
        subset: v1
        port:
          number: {{ .Values.service.httpPort }}
      weight: {{ sub 100 .Values.canary.trafficWeight }}
    - destination:
        host: {{ include "account.fullname" . }}
        subset: {{ .Values.canary.version }}
        port:
          number: {{ .Values.service.httpPort }}
      weight: {{ .Values.canary.trafficWeight }}
  {{- else }}
  # 默认稳定版本路由
  - match:
    - uri:
        prefix: /api/v1/accounts
    route:
    - destination:
        host: {{ include "account.fullname" . }}
        subset: v1
        port:
          number: {{ .Values.service.httpPort }}
      weight: 100
  {{- end }}
    retries:
      attempts: 3
      perTryTimeout: 2s
      retryOn: "gateway-error,connect-failure,refused-stream"
    timeout: 10s
    corsPolicy:
      {{- toYaml .Values.corsPolicy | nindent 6 | default "" }}
      {{- if not .Values.corsPolicy }}
      allowOrigins:
      - exact: "https://ecommerce.com"
      allowMethods: ["POST", "GET", "OPTIONS", "PUT", "DELETE"]
      allowHeaders: ["authorization", "content-type", "x-request-id"]
      maxAge: "24h"
      {{- end }}
---
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: {{ include "account.fullname" . }}
  namespace: {{ .Release.Namespace }}
spec:
  host: {{ include "account.fullname" . }}
  trafficPolicy:
    loadBalancer:
      simple: ROUND_ROBIN
      localityLbSetting:
        enabled: true
    tls:
      mode: ISTIO_MUTUAL
    connectionPool:
      tcp:
        maxConnections: 1024
        connectTimeout: 50ms
      http:
        http2MaxRequests: 2048
        maxRequestsPerConnection: 100
        idleTimeout: 60s
    outlierDetection:
      consecutive5xxErrors: 3
      interval: 5s
      baseEjectionTime: 60s
      maxEjectionPercent: 100
  subsets:
  - name: v1
    labels:
      version: v1
  {{- if .Values.canary.enabled }}
  - name: {{ .Values.canary.version }}
    labels:
      version: {{ .Values.canary.version }}
  {{- end }}
---
apiVersion: networking.istio.io/v1beta1
kind: Sidecar
metadata:
  name: {{ include "account.fullname" . }}-sidecar
  namespace: {{ .Release.Namespace }}
spec:
  workloadSelector:
    labels:
      app.kubernetes.io/name: {{ include "account.name" . }}
  egress:
  - hosts:
    - "istio-system/*"
    - "./*"
    - "default/payment.default.svc.cluster.local"
    - "default/inventory.default.svc.cluster.local"
---
---
apiVersion: telemetry.istio.io/v1alpha1
kind: Telemetry
metadata:
  name: {{ include "account.fullname" . }}-telemetry
  namespace: {{ .Release.Namespace }}
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: {{ include "account.name" . }}
  tracing:
  - providers:
    - name: {{ .Values.observability.tracing.provider }}
    randomSamplingPercentage: {{ .Values.observability.tracing.samplingRate }}
---

apiVersion: security.istio.io/v1beta1
kind: RequestAuthentication
metadata:
  name: {{ include "account.fullname" . }}-jwt
  namespace: {{ .Release.Namespace }}
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: {{ include "account.name" . }}
  jwtRules:
  - issuer: "ecommerce-auth-service"
    jwksUri: "http://auth-service.default.svc.cluster.local/v1/jwks" # 内部鉴权服务提供的 JWKS 终结点
    forwardOriginalToken: true # 转发原始 Token 供业务审计使用
---
---
apiVersion: telemetry.istio.io/v1alpha1
kind: Telemetry
metadata:
  name: {{ include "account.fullname" . }}-telemetry
  namespace: {{ .Release.Namespace }}
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: {{ include "account.name" . }}
  tracing:
  - providers:
    - name: {{ .Values.observability.tracing.provider }}
    randomSamplingPercentage: {{ .Values.observability.tracing.samplingRate }}
---

apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: {{ include "account.fullname" . }}-auth
  namespace: {{ .Release.Namespace }}
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: {{ include "account.name" . }}
  action: ALLOW
  rules:
  # 规则 1: 业务接口必须持有合法 JWT
  - from:
    - source:
        requestPrincipals: ["ecommerce-auth-service/*"]
    to:
    - operation:
        methods: ["POST", "PUT", "DELETE"]
        paths: ["/api/v1/accounts*"]
  # 规则 2: 服务间调用 (mTLS)
  - from:
    - source:
        principals: ["cluster.local/ns/{{ .Release.Namespace }}/sa/{{ include "account.serviceAccountName" . }}"]
  # 规则 3: 放行健康检查与指标采集
  - to:
    - operation:
        methods: ["GET"]
        paths: ["/sys/health", "/sys/ready", "/metrics"]
