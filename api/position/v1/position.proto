syntax = "proto3";

package position.v1;

import "google/protobuf/timestamp.proto";
import "position/v1/error_reason.proto";

option go_package = "github.com/wyfcoding/financialtrading/go-api/position/v1;v1";

service PositionService {
  rpc GetPosition(GetPositionRequest) returns (GetPositionResponse) {};
  rpc GetPositions(GetPositionsRequest) returns (GetPositionsResponse) {}; // Handler uses GetPositions (plural)
  rpc ClosePosition(ClosePositionRequest) returns (ClosePositionResponse) {};

  // DTM TCC Support
  rpc TccTryFreeze(TccPositionRequest) returns (TccPositionResponse) {};
  rpc TccConfirmFreeze(TccPositionRequest) returns (TccPositionResponse) {};
  rpc TccCancelFreeze(TccPositionRequest) returns (TccPositionResponse) {};

  // DTM Saga Support
  rpc SagaDeductFrozen(SagaPositionRequest) returns (SagaPositionResponse) {};
  rpc SagaRefundFrozen(SagaPositionRequest) returns (SagaPositionResponse) {};
  rpc SagaAddPosition(SagaPositionRequest) returns (SagaPositionResponse) {};
  rpc SagaSubPosition(SagaPositionRequest) returns (SagaPositionResponse) {};
}

message GetPositionRequest {
  string position_id = 1;
}

message Position {
  string position_id = 1;
  string user_id = 2;
  string symbol = 3;
  string side = 4;
  string quantity = 5;
  string entry_price = 6;
  string current_price = 7;
  string unrealized_pnl = 8;
  string realized_pnl = 9;
  int64 opened_at = 10;
  int64 closed_at = 11;
}

message GetPositionResponse {
  Position position = 1;
}

message GetPositionsRequest {
  string user_id = 1;
  int32 page_size = 2;
  int32 page = 3;
}

message GetPositionsResponse {
  repeated Position positions = 1;
  int64 total = 2;
}

message ClosePositionRequest {
  string position_id = 1;
  string close_price = 2;
}

message ClosePositionResponse {
  Position position = 1;
}

message TccPositionRequest {
  string user_id = 1;
  string symbol = 2;
  string quantity = 3; // Decimal string
  string order_id = 4;
}

message TccPositionResponse {
  bool success = 1;
}

message SagaPositionRequest {
  string user_id = 1;
  string symbol = 2;
  string quantity = 3;
  string price = 4;
}

message SagaPositionResponse {
  bool success = 1;
}
