syntax = "proto3";

package clearing;

option go_package = "github.com/fynnwu/FinancialTrading/go-api/clearing;clearing";

// 结算清算服务，负责已成交订单的资金划转及日终对账。
service ClearingService {
  // 对单笔达成的交易进行即时资金结算。
  rpc SettleTrade(SettleTradeRequest) returns (SettlementResponse);

  // 获取特定用户的历史清算单据列表。
  rpc GetSettlements(GetSettlementsRequest) returns (ListSettlementsResponse);

  // 触发指定日期的全量日终结算批处理任务。
  rpc ExecuteEODClearing(ExecuteEODClearingRequest) returns (EODClearingResponse);

  // 查询异步清算任务的执行状态。
  rpc GetClearingStatus(GetClearingStatusRequest) returns (ClearingStatusResponse);
}

// 交易清算请求。
message SettleTradeRequest {
  // 原始成交 ID。
  string trade_id = 1;
  // 买方用户 ID。
  string buy_user_id = 2;
  // 卖方用户 ID。
  string sell_user_id = 3;
  // 交易对。
  string symbol = 4;
  // 数量。
  string quantity = 5;
  // 成交价。
  string price = 6;
}

// 单笔清算结果。
message SettlementResponse {
  // 结算流水 ID。
  string settlement_id = 1;
  // 成交 ID。
  string trade_id = 2;
  // 状态 (COMPLETED, FAILED)。
  string status = 3;
  // 确认时间戳。
  int64 settlement_time = 4;
  // 异常错误描述。
  string error_message = 5;
}

// 历史查询请求。
message GetSettlementsRequest {
  // 用户 ID。
  string user_id = 1;
  // 返回限制。
  int32 limit = 2;
}

// 清算单详情。
message Settlement {
  // 流水 ID。
  string settlement_id = 1;
  // 成交 ID。
  string trade_id = 2;
  // 当前状态。
  string status = 3;
  // 时间。
  int64 settlement_time = 4;
}

// 列表响应。
message ListSettlementsResponse {
  // 清算单列表序列。
  repeated Settlement settlements = 1;
}

// 日终清算请求。
message ExecuteEODClearingRequest {
  // 目标业务日期 (YYYY-MM-DD)。
  string clearing_date = 1;
}

// 批处理响应概要。
message EODClearingResponse {
  // 任务 ID。
  string clearing_id = 1;
  // 任务状态。
  string status = 2;
  // 启动时间。
  int64 start_time = 3;
  // 完成时间。
  int64 end_time = 4;
  // 成功结算笔数。
  int64 trades_settled = 5;
}

// 任务进度查询请求。
message GetClearingStatusRequest {
  // 任务 ID。
  string clearing_id = 1;
}

// 进度详情响应。
message ClearingStatusResponse {
  // 任务 ID。
  string clearing_id = 1;
  // 状态。
  string status = 2;
  // 完成百分比。
  int64 progress_percentage = 3;
  // 已处理记录数。
  int64 trades_processed = 4;
  // 总待处理记录数。
  int64 trades_total = 5;
}
